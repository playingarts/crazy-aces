<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crazy Aces - Playing Arts</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #1a1a1a;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            padding: 20px;
        }

        @media (max-width: 480px) {
            body {
                padding: 8px 8px 8px 8px;
                align-items: flex-start;
                min-height: 100vh;
            }
        }

        .game-container {
            max-width: 1200px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
        }

        .player-name {
            font-size: 14px;
            font-weight: 500;
            color: rgba(255,255,255,0.8);
        }

        .opponent-hand-preview {
            display: inline-flex;
            gap: 8px;
            justify-content: center;
            padding: 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            min-height: 80px;
        }

        .card-back-small {
            width: 45px;
            height: 65px;
            background-image: url('https://s3.amazonaws.com/img.playingarts.com/one-small-hd/_backside-evgeny-kiselev.jpg?2');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            filter: grayscale(100%);
            opacity: 0.5;
        }

        .play-area {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
            padding: 0 40px;
            min-height: 350px;
            padding-bottom: 29px;
        }

        .deck-pile {
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .deck-pile:hover {
            transform: translateY(-5px);
        }

        @keyframes deckDraw {
            0%, 100% {
                transform: scale(1);
            }
            25% {
                transform: scale(0.95);
            }
            50% {
                transform: scale(1.02);
            }
            75% {
                transform: scale(0.98);
            }
        }

        .deck-pile.deck-drawing {
            animation: deckDraw 0.4s ease;
        }

        .card {
            width: 210px;
            height: 300px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            transition: all 0.3s ease;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: inherit;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 12px;
            z-index: 1;
            pointer-events: none;
        }

        .card.wild-card-played {
            animation: wildCardGlow 1s ease-out;
        }

        @keyframes wildCardGlow {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 40px rgba(255,215,0,0.8), 0 0 80px rgba(255,215,0,0.5);
            }
        }

        .card-back {
            background-image: url('https://s3.amazonaws.com/img.playingarts.com/one-small-hd/_backside-evgeny-kiselev.jpg?2');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
            overflow: hidden;
        }

        .discard-pile {
            position: relative;
        }

        .card-stack {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        @keyframes cardDrop {
            0% {
                transform: translateY(-100px) translateX(0) rotate(0deg);
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                transform: translateY(0) translateX(0) rotate(var(--rotation));
                opacity: 1;
            }
        }

        .card.card-animating {
            animation: cardDrop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .card .card-rank {
            display: none;
        }

        .card .card-suit {
            display: none;
        }

        .card-info {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 24px;
            color: rgba(255,255,255,0.8);
            white-space: nowrap;
            z-index: 0;
        }

        .card-info .info-rank {
            font-weight: bold;
            font-size: 48px;
        }

        .card-info .info-suit {
            font-size: 52px;
        }

        .card-info .info-joker {
            font-weight: bold;
            font-size: 20px;
            color: #FFD700;
        }

        .card.spades { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: 3px solid #667eea; }
        .card.hearts { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: 3px solid #f093fb; }
        .card.diamonds { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border: 3px solid #4facfe; }
        .card.clubs { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); border: 3px solid #43e97b; }
        .card.joker { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); border: 3px solid #FFD700; }

        .card-rank {
            font-size: 72px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: absolute;
            top: 15px;
            left: 15px;
        }

        .card-suit {
            font-size: 84px;
            filter: brightness(0) invert(1);
        }

        .card-artist {
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 15px;
            color: rgba(255,255,255,0.9);
            padding: 0;
            background: none;
            border-radius: 0;
            white-space: nowrap;
            opacity: 0.5;
            transition: opacity 0.3s ease;
            z-index: 2;
        }

        .card-artist:hover {
            opacity: 1;
        }

        .player-hand {
            background: #f5f5f5;
            border-radius: 20px;
            padding: 13px;
            display: inline-block;
            margin: 0 auto;
        }

        .hand-cards {
            display: flex;
            gap: 7px;
            justify-content: center;
            flex-wrap: nowrap;
            overflow-x: visible;
        }

        .hand-card {
            width: 60px;
            height: 87px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #1a1a1a;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            flex-shrink: 0;
        }

        .hand-card.ace-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.6);
        }

        .hand-card.joker-card {
            background: linear-gradient(270deg, #FFD700, #FFA500, #FF6347, #FFA500, #FFD700);
            background-size: 400% 400%;
            animation: jokerGlow 6s ease infinite;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.6);
        }

        @keyframes jokerGlow {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .hand-card .card-rank {
            font-size: 28px;
            font-weight: bold;
            color: white;
            text-shadow: none;
            position: static;
            line-height: 1;
            text-align: center;
        }

        .hand-card .card-suit {
            font-size: 25px;
            filter: brightness(0) invert(1);
            margin-top: 5px;
            line-height: 1;
            text-align: center;
        }

        .joker-text {
            font-size: 12px !important;
            font-weight: 700;
        }

        @media (min-width: 768px) {
            .card {
                width: 225px;
                height: 322px;
            }
            
            .card .card-rank {
                font-size: 78px;
            }
            
            .card .card-suit {
                font-size: 90px;
            }
            
            .play-area {
                gap: 35px;
                padding: 0 45px;
                min-height: 420px;
                padding-bottom: 60px;
            }
            
            .opponent-hand-preview {
                padding: 18px;
                min-height: 90px;
            }
            
            .card-back-small {
                width: 50px;
                height: 72px;
            }
        }

        @media (min-width: 1200px) {
            .card {
                width: 255px;
                height: 365px;
            }
            
            .card .card-rank {
                font-size: 87px;
            }
            
            .card .card-suit {
                font-size: 102px;
            }
            
            .play-area {
                gap: 40px;
                padding: 0 50px;
                min-height: 480px;
                padding-bottom: 60px;
            }
            
            .opponent-hand-preview {
                padding: 20px;
                min-height: 95px;
            }
            
            .card-back-small {
                width: 54px;
                height: 78px;
            }
        }

        @media (max-width: 480px) {
            .card {
                width: 140px;
                height: 200px;
            }

            .card .card-rank {
                font-size: 38px;
            }

            .card .card-suit {
                font-size: 45px;
            }

            .play-area {
                gap: 30px;
                padding: 0 8px;
                min-height: 240px;
                padding-bottom: 75px;
            }

            .opponent-hand-preview {
                padding: 12px;
                min-height: 75px;
                gap: 8px;
            }

            .card-back-small {
                width: 32px;
                height: 46px;
            }

            .status-message {
                font-size: 10px;
                padding: 12px;
                min-height: 54px;
            }

            .hand-card {
                width: 45px;
                height: 65px;
            }

            .hand-card .card-rank {
                font-size: 18px;
            }

            .hand-card .card-suit {
                font-size: 16px;
                margin-top: 3px;
            }

            .joker-text {
                font-size: 7px !important;
            }

            .hand-cards {
                gap: 5px;
                padding: 12px 8px 0 8px;
                overflow-x: auto;
                overflow-y: visible;
                -webkit-overflow-scrolling: touch;
            }

            .hand-cards::-webkit-scrollbar {
                height: 3px;
            }

            .hand-cards::-webkit-scrollbar-track {
                background: rgba(255,255,255,0.05);
                border-radius: 2px;
            }

            .hand-cards::-webkit-scrollbar-thumb {
                background: rgba(255,255,255,0.2);
                border-radius: 2px;
            }

            .player-hand {
                padding: 15px;
                max-width: 100%;
                overflow: visible;
            }

            .game-container {
                gap: 23px;
            }

            .top-bar {
                padding: 15px 18px;
            }

            .player-name {
                font-size: 11px;
            }

            .hand-card {
                flex-shrink: 0;
                min-width: 45px;
                transform: translateY(0) scale(1);
                transition: transform 0.2s ease;
                position: relative;
                z-index: 1;
            }

            .hand-card:hover {
                transform: translateY(0) scale(1);
            }

            .hand-card:active {
                transform: translateY(-8px) scale(1.05);
                z-index: 10;
            }

            .suit-selector {
                padding: 25px;
                max-width: 90%;
            }

            .suit-selector-title {
                font-size: 13px;
            }

            .suit-options {
                gap: 12px;
            }

            .suit-option {
                width: 60px;
                height: 60px;
                font-size: 29px;
            }

            .game-over {
                padding: 30px;
                max-width: 90%;
            }

            .result-text {
                font-size: 13px;
            }

            .play-again-btn {
                padding: 8px 20px;
                font-size: 7px;
            }

            .stats-text {
                font-size: 11px;
            }
        }

        .hand-card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
        }

        .status-message {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            font-size: 15px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.5;
        }

        .suit-selector {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(20,20,20,0.98);
            padding: 40px;
            border-radius: 20px;
            border: 2px solid rgba(255,255,255,0.1);
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            z-index: 1000;
            display: none;
        }

        .suit-selector.show {
            display: block;
        }

        .suit-selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .suit-selector-title {
            font-size: 18px;
            color: rgba(255,255,255,0.9);
            flex: 1;
            text-align: center;
        }

        .close-selector-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.7);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .close-selector-btn:hover {
            background: rgba(255,255,255,0.2);
            color: rgba(255,255,255,1);
            transform: scale(1.1);
        }

        .suit-options {
            display: flex;
            gap: 20px;
        }

        .suit-option {
            width: 80px;
            height: 80px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .suit-option:hover {
            transform: scale(1.1);
            border-color: rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.1);
        }

        .suit-option.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            pointer-events: none;
        }

        .suit-option.disabled:hover {
            transform: none;
        }

        .game-over {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(20,20,20,0.98);
            padding: 50px;
            border-radius: 20px;
            border: 2px solid rgba(255,255,255,0.1);
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            text-align: center;
            z-index: 1000;
            display: none;
        }

        .game-over.show {
            display: block;
        }

        .result-text {
            font-size: 42px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .result-text.win {
            color: #43e97b;
        }

        .result-text.lose {
            color: #f5576c;
        }

        .stats-text {
            font-size: 16px;
            color: rgba(255,255,255,0.7);
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .play-again-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 20px 60px;
            font-size: 20px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s ease;
            margin-top: 30px;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .play-again-btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: scale(1.08);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.6);
        }

        .reset-stats-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.6);
            padding: 8px 20px;
            font-size: 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .reset-stats-btn:hover {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.8);
        }

        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #f0f;
            animation: confetti-fall linear forwards;
        }

        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

    </style>
    
    <!-- Preload card back for immediate availability -->
    <link rel="preload" as="image" href="https://s3.amazonaws.com/img.playingarts.com/one-small-hd/_backside-evgeny-kiselev.jpg?2">
</head>
<body>
    <div class="confetti-container" id="confettiContainer"></div>
    <div class="game-container">
        <div style="display: flex; justify-content: center;">
            <div class="opponent-hand-preview" id="opponentHandPreview">
                <!-- Card backs will be generated here -->
            </div>
        </div>

        <div class="status-message" id="statusMessage">
            Match the rank or suit of the center card
        </div>

        <div class="play-area">
            <div class="deck-pile" onclick="drawCard()">
                <div class="card card-back" id="deckCard"></div>
            </div>

            <div class="discard-pile" id="discardPile">
                <div class="card" id="topCard">
                    <!-- Top discard card -->
                </div>
                <div class="card-stack" id="cardStack">
                    <!-- Previous cards stack here -->
                </div>
            </div>
        </div>

        <div style="display: flex; justify-content: center;">
            <div class="player-hand">
                <div class="hand-cards" id="playerHand">
                    <!-- Player cards will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <div class="suit-selector" id="suitSelector">
        <div class="suit-selector-header">
            <div class="suit-selector-title">Choose a suit</div>
            <button class="close-selector-btn" onclick="closeSuitSelector()">✕</button>
        </div>
        <div class="suit-options">
            <div class="suit-option" id="suit-spades" onclick="chooseSuit('♠️')">♠️</div>
            <div class="suit-option" id="suit-hearts" onclick="chooseSuit('♥️')">♥️</div>
            <div class="suit-option" id="suit-diamonds" onclick="chooseSuit('♦️')">♦️</div>
            <div class="suit-option" id="suit-clubs" onclick="chooseSuit('♣️')">♣️</div>
        </div>
    </div>

    <div class="game-over" id="gameOver">
        <div class="result-text" id="resultText"></div>
        <button class="play-again-btn" onclick="initGame()">Play Again</button>
        <div class="stats-text" id="statsText"></div>
        <button class="reset-stats-btn" onclick="resetStats()">Reset Statistics</button>
    </div>

    <script>
        const cardData = {
            '2♠️': { artist: 'Mattias Adolfsson' }, '3♠️': { artist: 'Teagan White' },
            '4♠️': { artist: 'Serial Cut' }, '5♠️': { artist: 'Musketon' },
            '6♠️': { artist: 'Fernando Volken Togni' }, '7♠️': { artist: 'Muxxi' },
            '8♠️': { artist: 'Gary Fernández' }, '9♠️': { artist: 'Anton Repponen' },
            '10♠️': { artist: 'Bicicleta Sem Freio' }, 'J♠️': { artist: 'Seb Niark1' },
            'Q♠️': { artist: 'David Mack' }, 'K♠️': { artist: 'Yulia Brodskaya' },
            'A♠️': { artist: 'Iain Macarthur' },
            
            '2♥️': { artist: 'Peter Tarka' }, '3♥️': { artist: 'Mercedes deBellard' },
            '4♥️': { artist: 'Ruben Ireland' }, '5♥️': { artist: 'Aitch' },
            '6♥️': { artist: 'Javier Medellin Puyou' }, '7♥️': { artist: 'Felix LaFlamme' },
            '8♥️': { artist: 'Raul Urias' }, '9♥️': { artist: 'Carlos Lerma' },
            '10♥️': { artist: 'Caramelaw' }, 'J♥️': { artist: 'Steve Simpson' },
            'Q♥️': { artist: 'Conrad Roset' }, 'K♥️': { artist: 'Sara Blake' },
            'A♥️': { artist: 'Mr. Kone' },
            
            '2♦️': { artist: 'YemaYema' }, '3♦️': { artist: 'Carne Griffiths' },
            '4♦️': { artist: 'Peter Olschinsky' }, '5♦️': { artist: 'Fab Ciraolo' },
            '6♦️': { artist: 'VASAVA' }, '7♦️': { artist: 'Matt W. Moore' },
            '8♦️': { artist: 'Jthree Concepts' }, '9♦️': { artist: 'Pirecco' },
            '10♦️': { artist: 'Lei Melendres' }, 'J♦️': { artist: 'Newfren' },
            'Q♦️': { artist: 'agnes-cecile' }, 'K♦️': { artist: 'Saturno' },
            'A♦️': { artist: 'Jordan Debney' },
            
            '2♣️': { artist: 'Tang Yau Hoong' }, '3♣️': { artist: 'Fernando Chamarelli' },
            '4♣️': { artist: 'MUTI' }, '5♣️': { artist: 'Valerie Ann Chua' },
            '6♣️': { artist: 'Tobias van Schneider' }, '7♣️': { artist: 'Krzysztof CHKN Nowak' },
            '8♣️': { artist: 'El Grand Chamaco' }, '9♣️': { artist: 'Chuck Anderson' },
            '10♣️': { artist: 'Hey' }, 'J♣️': { artist: 'Bakea' },
            'Q♣️': { artist: 'Ise Ananphada' }, 'K♣️': { artist: 'James White' },
            'A♣️': { artist: 'Andreas Preis' },
            
            'JOKER_1': { artist: 'Mike Friedrich' },
            'JOKER_2': { artist: 'Joshua Davis' }
        };

        const suits = ['♠️', '♥️', '♦️', '♣️'];
        const ranks = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];

        let deck = [];
        let playerHand = [];
        let computerHand = [];
        let discardPile = [];
        let currentSuit = null;
        let currentRank = null;
        let gameOver = false;
        let pendingEightCard = null;
        let isComputerTurn = false;
        let isFirstMove = true;
        let suitWasChanged = false;
        let isDrawing = false; // Prevent multiple simultaneous draws
        let jokerWasPlayed = false; // Track if joker was just played
        
        // Win rate tracking
        let playerWins = parseInt(localStorage.getItem('crazyAcesPlayerWins')) || 0;
        let computerWins = parseInt(localStorage.getItem('crazyAcesComputerWins')) || 0;

        function createDeck() {
            const newDeck = [];
            for (let suit of suits) {
                for (let rank of ranks) {
                    newDeck.push(createCard(rank, suit));
                }
            }
            // Add 2 jokers
            newDeck.push({ rank: 'JOKER', suit: 'joker', artist: 'Mike Friedrich', isJoker: true });
            newDeck.push({ rank: 'JOKER', suit: 'joker', artist: 'Joshua Davis', isJoker: true });
            return shuffleDeck(newDeck);
        }

        function createCard(rank, suit) {
            const cardKey = `${rank}${suit}`;
            const data = cardData[cardKey];
            return {
                rank,
                suit,
                artist: data ? data.artist : 'Unknown',
                isAce: rank === 'A',
                isJoker: false
            };
        }

        function shuffleDeck(deck) {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        }

        // Card image URLs from Playing Arts deck
        const cardImages = {
            '2♣️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/2-of-clubs-tang-yau-hoong.jpg?2',
            '2♦️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/2-of-diamonds-yemayema.jpg?2',
            '2♥️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/2-of-hearts-peter-tarka.jpg?2',
            '2♠️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/2-of-spades-mattias-adolfsson.jpg?2',
            '3♣️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/3-of-clubs-fernando-chamarelli.jpg?2',
            '3♦️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/3-of-diamonds-carne-griffiths.jpg?2',
            '3♥️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/3-of-hearts-mercedes-debellard.jpg?2',
            '3♠️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/3-of-spades-teagan-white.jpg?2',
            '4♣️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/4-of-clubs-muti.jpg?2',
            '4♦️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/4-of-diamonds-peter-olschinsky.jpg?2',
            '4♥️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/4-of-hearts-ruben-ireland.jpg?2',
            '4♠️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/4-of-spades-serial-cut.jpg?2',
            '5♣️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/5-of-clubs-valerie-ann-chua.jpg?2',
            '5♦️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/5-of-diamonds-fab-ciraolo.jpg?2',
            '5♥️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/5-of-hearts-aitch.jpg?2',
            '5♠️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/5-of-spades-musketon.jpg?2',
            '6♣️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/6-of-clubs-tobias-van-schneider.jpg?2',
            '6♦️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/6-of-diamonds-vasava.jpg?2',
            '6♥️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/6-of-hearts-javier-medellin-puyou.jpg?2',
            '6♠️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/6-of-spades-fernando-volken-togni.jpg?2',
            '7♣️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/7-of-clubs-krzysztof-nowak.jpg?2',
            '7♦️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/7-of-diamonds-matt-w-moore.jpg?2',
            '7♥️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/7-of-hearts-felix-laflamme.jpg?2',
            '7♠️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/7-of-spades-muxxi.jpg?2',
            '8♣️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/8-of-clubs-el-grand-chamaco.jpg?2',
            '8♦️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/8-of-diamonds-jthree-concepts.jpg?2',
            '8♥️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/8-of-hearts-raul-urias.jpg?2',
            '8♠️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/8-of-spades-gary-fernandez.jpg?2',
            '9♣️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/9-of-clubs-chuck-anderson.jpg?2',
            '9♦️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/9-of-diamonds-pirecco.jpg?2',
            '9♥️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/9-of-hearts-carlos-lerma.jpg?2',
            '9♠️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/9-of-spades-anton-repponen.jpg?2',
            '10♣️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/10-of-clubs-hey.jpg?2',
            '10♦️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/10-of-diamonds-lei-melendres.jpg?2',
            '10♥️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/10-of-hearts-caramelaw.jpg?2',
            '10♠️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/10-of-spades-bicicleta-sem-freio.jpg?2',
            'J♣️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/jack-of-clubs-bakea.jpg?2',
            'J♦️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/jack-of-diamonds-newfren.jpg?2',
            'J♥️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/jack-of-hearts-steve-simpson.jpg?2',
            'J♠️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/jack-of-spades-seb-niark1.jpg?2',
            'Q♣️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/queen-of-clubs-ise-ananphada.jpg?2',
            'Q♦️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/queen-of-diamonds-agnes-cecile.jpg?2',
            'Q♥️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/queen-of-hearts-conrad-roset.jpg?2',
            'Q♠️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/queen-of-spades-david-mack.jpg?2',
            'K♣️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/king-of-clubs-james-white.jpg?2',
            'K♦️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/king-of-diamonds-saturno-the-creatter.jpg?2',
            'K♥️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/king-of-hearts-sara-blake.jpg?2',
            'K♠️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/king-of-spades-yulia-brodskaya.jpg?2',
            'A♣️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/ace-of-clubs-andreas-preis.jpg?2',
            'A♦️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/ace-of-diamonds-jordan-debney.jpg?2',
            'A♥️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/ace-of-hearts-mr-kone.jpg?2',
            'A♠️': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/ace-of-spades-iain-macarthur.jpg?2',
            'JOKER': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/joker-mike-friedrich.jpg?2',
            'JOKER_2': 'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/joker-joshua-davis.jpg?2'
        };

        function getCardImageUrl(card) {
            if (card.isJoker) {
                return card.artist === 'Mike Friedrich' ? cardImages['JOKER'] : cardImages['JOKER_2'];
            }
            const key = card.rank + card.suit;
            return cardImages[key] || '';
        }

        function getSuitClass(suit) {
            const suitMap = { '♠️': 'spades', '♥️': 'hearts', '♦️': 'diamonds', '♣️': 'clubs', 'joker': 'joker' };
            return suitMap[suit] || '';
        }

        function initGame() {
            deck = createDeck();
            console.log(`Deck created with ${deck.length} cards`);
            playerHand = deck.splice(0, 7);
            computerHand = deck.splice(0, 7);
            console.log(`After dealing: ${deck.length} cards remaining in deck`);
            
            // First discard card (not Ace or joker)
            let firstCard;
            do {
                firstCard = deck.shift();
            } while (firstCard.isAce || firstCard.isJoker);
            
            discardPile = [firstCard];
            currentSuit = firstCard.suit;
            currentRank = firstCard.rank;
            gameOver = false;
            pendingEightCard = null;
            isComputerTurn = false;
            isFirstMove = true;
            suitWasChanged = false;
            isDrawing = false;
            jokerWasPlayed = false;

            document.getElementById('gameOver').classList.remove('show');
            updateStatus('Click a card to play it, or draw from the deck. Match the rank or suit!');
            updateDisplay();
            console.log(`Game started. Deck: ${deck.length}, Player: ${playerHand.length}, Computer: ${computerHand.length}, Discard: ${discardPile.length}`);
        }

        function updateDisplay(animate = true) {
            renderOpponentHand();
            renderTopCard(animate);
            renderPlayerHand();
        }

        function renderOpponentHand() {
            const container = document.getElementById('opponentHandPreview');
            container.innerHTML = '';
            
            for (let i = 0; i < computerHand.length; i++) {
                const cardBack = document.createElement('div');
                cardBack.className = 'card-back-small';
                container.appendChild(cardBack);
            }
        }

        function renderTopCard(animate = true) {
            const topCardEl = document.getElementById('topCard');
            const card = discardPile[discardPile.length - 1];
            const imageUrl = getCardImageUrl(card);
            
            // First card is straight (0°), subsequent cards have slight rotation (-3 to 3 degrees)
            const isFirstCard = discardPile.length === 1;
            const rotation = isFirstCard ? 0 : (Math.random() - 0.5) * 6;
            
            // Only add animation class if animate is true
            topCardEl.className = animate ? 'card card-animating' : 'card';
            topCardEl.style.backgroundImage = `url('${imageUrl}')`;
            topCardEl.style.setProperty('--rotation', `${rotation}deg`);
            topCardEl.style.transform = `rotate(${rotation}deg)`;
            
            // Remove animation class after animation completes
            if (animate) {
                setTimeout(() => {
                    topCardEl.classList.remove('card-animating');
                }, 400);
            }
            
            // Render previous cards stack (last 3 cards before current)
            const stackEl = document.getElementById('cardStack');
            stackEl.innerHTML = '';
            
            const stackCount = Math.min(3, discardPile.length - 1);
            for (let i = 1; i <= stackCount; i++) {
                const prevCard = discardPile[discardPile.length - 1 - i];
                const prevImageUrl = getCardImageUrl(prevCard);
                const stackCard = document.createElement('div');
                stackCard.className = 'card';
                stackCard.style.backgroundImage = `url('${prevImageUrl}')`;
                stackCard.style.position = 'absolute';
                stackCard.style.zIndex = -i;
                
                // Slight offset and rotation for stacked cards (-3 to 3 degrees)
                const stackRotation = (Math.random() - 0.5) * 6;
                stackCard.style.transform = `translate(${i * -3}px, ${i * 2}px) rotate(${stackRotation}deg)`;
                stackCard.style.opacity = 0.3;
                
                stackEl.appendChild(stackCard);
            }
            
            // If suit was changed (Ace/Joker played and suit selected), show the NEW suit
            if (suitWasChanged && (card.isJoker || card.isAce)) {
                topCardEl.innerHTML = `
                    <div class="card-info">
                        <span class="info-suit">${currentSuit}</span>
                    </div>
                `;
            } else if (card.isJoker) {
                // Show JOKER text below image (before suit is chosen)
                topCardEl.innerHTML = `
                    <div class="card-info">
                        <span class="info-joker">JOKER</span>
                    </div>
                    <div class="card-artist">${card.artist}</div>
                `;
                
                // Add animation class
                topCardEl.classList.add('wild-card-played');
                setTimeout(() => {
                    topCardEl.classList.remove('wild-card-played');
                }, 1000);
            } else if (card.isAce) {
                // Show Ace rank and suit below image (before suit is chosen)
                topCardEl.innerHTML = `
                    <div class="card-info">
                        <span class="info-rank">${card.rank}</span>
                        <span class="info-suit">${card.suit}</span>
                    </div>
                    <div class="card-artist">${card.artist}</div>
                `;
                
                // Add animation class
                topCardEl.classList.add('wild-card-played');
                setTimeout(() => {
                    topCardEl.classList.remove('wild-card-played');
                }, 1000);
            } else {
                // Show rank and suit below image for regular cards
                topCardEl.innerHTML = `
                    <div class="card-info">
                        <span class="info-rank">${card.rank}</span>
                        <span class="info-suit">${card.suit}</span>
                    </div>
                    <div class="card-artist">${card.artist}</div>
                `;
            }
        }

        function renderPlayerHand() {
            const handEl = document.getElementById('playerHand');
            handEl.innerHTML = '';
            
            // Separate Aces/Jokers and other cards
            const aces = playerHand.filter(card => card.isAce || card.isJoker);
            const regularCards = playerHand.filter(card => !card.isAce && !card.isJoker);
            
            // Render Aces first (on the left)
            aces.forEach((card) => {
                const actualIndex = playerHand.indexOf(card);
                const cardEl = document.createElement('div');
                
                // Use different class for Jokers vs Aces
                if (card.isJoker) {
                    cardEl.className = 'hand-card joker-card';
                    cardEl.innerHTML = `
                        <div class="card-rank joker-text">JOKER</div>
                    `;
                } else {
                    cardEl.className = 'hand-card ace-card';
                    // Show only "A" for Aces, no suit symbol
                    cardEl.innerHTML = `
                        <div class="card-rank">${card.rank}</div>
                    `;
                }
                
                if (!gameOver) {
                    cardEl.onclick = () => playCard(actualIndex);
                }
                
                handEl.appendChild(cardEl);
            });
            
            // Render regular cards
            regularCards.forEach((card) => {
                const actualIndex = playerHand.indexOf(card);
                const cardEl = document.createElement('div');
                cardEl.className = 'hand-card';
                
                cardEl.innerHTML = `
                    <div class="card-rank">${card.rank}</div>
                    <div class="card-suit">${card.suit}</div>
                `;
                
                if (!gameOver) {
                    cardEl.onclick = () => playCard(actualIndex);
                }
                
                handEl.appendChild(cardEl);
            });
        }

        function canPlayCard(card) {
            if (!card) return false;
            if (card.isJoker) return true;
            if (card.isAce) return true;
            if (jokerWasPlayed) return true; // Any card can be played after joker
            if (card.suit === currentSuit) return true;
            if (card.rank === currentRank) return true;
            return false;
        }

        function playCard(index) {
            if (gameOver || isComputerTurn || pendingEightCard) return;
            
            const card = playerHand[index];
            
            // Safety check
            if (!card) return;
            
            // Check if card can be played
            if (!canPlayCard(card)) {
                updateStatus('Cannot play that card');
                setTimeout(() => updateStatus(''), 1500);
                return;
            }
            
            // LOCK TURN IMMEDIATELY before any other operations
            isComputerTurn = true;
            
            // Clear rules message on first move
            if (isFirstMove) {
                isFirstMove = false;
            }
            
            playerHand.splice(index, 1);
            discardPile.push(card);

            // Reset suit change flag for new card
            suitWasChanged = false;

            if (card.isJoker) {
                // Joker = wild - play any card next to define suit
                jokerWasPlayed = true;
                isComputerTurn = false; // Keep turn unlocked
                updateStatus('You played Joker - play another card to define the suit');
                updateDisplay();
                return;
            }

            // Check if this card was played after a Joker
            const wasAfterJoker = jokerWasPlayed;
            if (jokerWasPlayed) {
                jokerWasPlayed = false;
                suitWasChanged = true; // Show that suit was changed by joker
            }

            if (card.isAce) {
                // Ace = change suit
                pendingEightCard = card;
                isComputerTurn = false; // Unlock while waiting for suit selection
                updateStatus('You played Ace - choose a suit');
                updateSuitSelector(); // Update which suits are available
                document.getElementById('suitSelector').classList.add('show');
                return;
            }

            currentSuit = card.suit;
            currentRank = card.rank;

            if (wasAfterJoker) {
                updateStatus(`You played ${card.rank}${card.suit} - suit is now ${card.suit}`);
                setTimeout(() => updateStatus(''), 2000);
            } else {
                updateStatus(`You played ${card.rank}${card.suit}`);
                setTimeout(() => updateStatus(''), 1500);
            }
            
            if (playerHand.length === 0) {
                endGame('player');
                return;
            }
            
            updateDisplay();
            setTimeout(() => {
                computerTurn();
            }, 800);
        }

        function chooseSuit(suit) {
            document.getElementById('suitSelector').classList.remove('show');
            currentSuit = suit;
            currentRank = pendingEightCard.rank;
            
            const wasJoker = pendingEightCard.isJoker;
            
            // Transform the Ace/Joker card in discard pile to show the chosen suit
            if (pendingEightCard.isAce) {
                // Find the last card in discard pile (should be the Ace just played)
                const lastCard = discardPile[discardPile.length - 1];
                lastCard.suit = suit; // Change suit to chosen suit
                lastCard.isAce = false; // No longer wild - it's now a specific Ace
                suitWasChanged = false; // Don't need special rendering
            } else {
                suitWasChanged = true; // Keep flag for Jokers
            }
            
            pendingEightCard = null;
            
            updateStatus(`You changed suit to ${suit}`);
            setTimeout(() => updateStatus(''), 2000);
            
            if (playerHand.length === 0) {
                endGame('player');
                return;
            }
            
            updateDisplay();
            
            // If joker was played, skip computer's turn
            if (!wasJoker) {
                isComputerTurn = true;
                setTimeout(() => {
                    computerTurn();
                }, 800);
            }
        }

        function updateSuitSelector() {
            // Check which Aces have been played in the discard pile
            const playedAceSuits = new Set();
            discardPile.forEach(card => {
                if (card.rank === 'A' && !card.isAce) {
                    // This is an Ace that has been transformed (suit was chosen)
                    playedAceSuits.add(card.suit);
                }
            });
            
            // Enable/disable suit options based on played Aces
            const suitMap = {
                '♠️': 'suit-spades',
                '♥️': 'suit-hearts',
                '♦️': 'suit-diamonds',
                '♣️': 'suit-clubs'
            };
            
            Object.entries(suitMap).forEach(([suit, id]) => {
                const element = document.getElementById(id);
                if (playedAceSuits.has(suit)) {
                    element.classList.add('disabled');
                } else {
                    element.classList.remove('disabled');
                }
            });
        }

        function closeSuitSelector() {
            // Return the card to player's hand
            if (pendingEightCard) {
                discardPile.pop(); // Remove from discard pile
                playerHand.push(pendingEightCard); // Add back to hand
                pendingEightCard = null;
            }
            
            document.getElementById('suitSelector').classList.remove('show');
            updateDisplay();
            updateStatus('Card returned to hand');
            setTimeout(() => updateStatus(''), 1500);
        }

        function drawCard() {
            // Check all locks including the drawing lock
            if (gameOver || isComputerTurn || pendingEightCard || isDrawing) return;

            // LOCK DRAWING IMMEDIATELY before any other operations
            isDrawing = true;
            isComputerTurn = true;

            // Clear rules message on first move
            if (isFirstMove) {
                isFirstMove = false;
            }

            // Clear joker flag if drawing after joker
            if (jokerWasPlayed) {
                jokerWasPlayed = false;
            }

            if (deck.length === 0) {
                updateStatus('Deck empty - pass turn');
                setTimeout(() => {
                    updateStatus('');
                    isDrawing = false; // Unlock drawing
                    computerTurn();
                }, 1500);
                return;
            }
            
            const card = deck.shift();
            if (!card) {
                // Safety check - deck was empty
                updateStatus('Deck empty - pass turn');
                setTimeout(() => {
                    updateStatus('');
                    isDrawing = false; // Unlock drawing
                    computerTurn();
                }, 1500);
                return;
            }

            playerHand.push(card);
            animateDeckDraw(); // Animate the deck pile
            updateStatus('You drew a card');
            setTimeout(() => updateStatus(''), 1200);
            updateDisplay(false); // No animation when drawing
            
            if (!canPlayCard(card)) {
                // Card can't be played, computer's turn
                setTimeout(() => {
                    isDrawing = false; // Unlock drawing before computer turn
                    computerTurn();
                }, 1000);
            } else {
                // Card can be played, unlock turn for player to play it
                isComputerTurn = false;
                isDrawing = false; // Unlock drawing
            }
        }

        function computerTurn() {
            if (gameOver) return;
            
            // Find playable cards
            const playableCards = computerHand.filter(canPlayCard);
            
            if (playableCards.length === 0) {
                // Must draw
                if (deck.length > 0) {
                    const card = deck.shift();
                    if (!card) {
                        // Deck empty after shift
                        updateDisplay(false); // No animation
                        isComputerTurn = false;
                        return;
                    }
                    computerHand.push(card);
                    animateDeckDraw(); // Animate the deck pile
                    updateStatus('Computer drew a card');
                    setTimeout(() => updateStatus(''), 1200);
                    updateDisplay(false); // Update display without animating the face-up card
                    
                    if (canPlayCard(card)) {
                        setTimeout(() => {
                            const index = computerHand.indexOf(card);
                            if (index !== -1) {
                                computerPlayCard(index);
                            } else {
                                isComputerTurn = false;
                            }
                        }, 1200);
                    } else {
                        setTimeout(() => {
                            isComputerTurn = false;
                        }, 1200);
                    }
                } else {
                    // Deck empty, computer must pass
                    updateStatus('Computer passes');
                    setTimeout(() => updateStatus(''), 1500);
                    isComputerTurn = false;
                }
                return;
            }
            
            // Play lowest non-special card, or special if needed
            playableCards.sort((a, b) => {
                if (a.isJoker) return 1;
                if (b.isJoker) return -1;
                if (a.isAce) return 1;
                if (b.isAce) return -1;
                const rankOrder = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
                return rankOrder.indexOf(a.rank) - rankOrder.indexOf(b.rank);
            });
            
            const cardToPlay = playableCards[0];
            const index = computerHand.indexOf(cardToPlay);
            
            if (index !== -1) {
                setTimeout(() => {
                    computerPlayCard(index);
                }, 800);
            } else {
                isComputerTurn = false;
            }
        }

        function computerPlayCard(index) {
            const card = computerHand[index];
            computerHand.splice(index, 1);
            discardPile.push(card);

            if (card.isJoker) {
                // Set flag that joker was played
                jokerWasPlayed = true;
                updateStatus('Computer played Joker');
                setTimeout(() => updateStatus(''), 1500);

                // Check if game is over
                if (computerHand.length === 0) {
                    endGame('computer');
                    return;
                }

                // Update display after Joker
                updateDisplay();

                // Continue turn - play another card after delay
                setTimeout(() => {
                    const playableCards = computerHand.filter(canPlayCard);
                    if (playableCards.length > 0) {
                        // Choose best card (prefer cards matching most common suit)
                        const suitCounts = {};
                        computerHand.forEach(c => {
                            if (!c.isJoker && !c.isAce) {
                                suitCounts[c.suit] = (suitCounts[c.suit] || 0) + 1;
                            }
                        });
                        const bestSuit = Object.keys(suitCounts).sort((a,b) => suitCounts[b] - suitCounts[a])[0];

                        // Prefer card with best suit
                        let cardToPlay = playableCards.find(c => c.suit === bestSuit) || playableCards[0];
                        const cardIndex = computerHand.indexOf(cardToPlay);
                        computerPlayCard(cardIndex);
                    } else {
                        // Can't play, end turn
                        jokerWasPlayed = false;
                        isComputerTurn = false;
                    }
                }, 1500);
                return; // Exit early, turn continues
            } else if (card.isAce) {
                // Choose most common suit in hand
                const suitCounts = {};
                computerHand.forEach(c => {
                    if (!c.isJoker && !c.isAce) {
                        suitCounts[c.suit] = (suitCounts[c.suit] || 0) + 1;
                    }
                });
                const bestSuit = Object.keys(suitCounts).sort((a,b) => suitCounts[b] - suitCounts[a])[0] || suits[0];
                currentSuit = bestSuit;
                currentRank = card.rank;

                // Transform the Ace card to show the chosen suit
                card.suit = bestSuit;
                card.isAce = false; // No longer wild
                suitWasChanged = false;

                updateStatus(`Computer played Ace - changed to ${currentSuit}`);
                setTimeout(() => updateStatus(''), 2500);
            } else {
                // If this card was played after a Joker, clear the flag
                if (jokerWasPlayed) {
                    jokerWasPlayed = false;
                    suitWasChanged = true;
                    updateStatus(`Computer played ${card.rank}${card.suit} after Joker`);
                    setTimeout(() => updateStatus(''), 2000);
                } else {
                    suitWasChanged = false;
                    updateStatus(`Computer played ${card.rank}${card.suit}`);
                    setTimeout(() => updateStatus(''), 1500);
                }
                currentSuit = card.suit;
                currentRank = card.rank;
            }
            
            if (computerHand.length === 0) {
                endGame('computer');
                return;
            }
            
            updateDisplay();
            isComputerTurn = false; // Unlock turn for player
        }

        function updateStatus(message) {
            const statusEl = document.getElementById('statusMessage');
            if (message) {
                statusEl.textContent = message;
            } else {
                statusEl.textContent = '';
            }
        }

        function animateDeckDraw() {
            const deckPile = document.querySelector('.deck-pile');
            deckPile.classList.add('deck-drawing');
            setTimeout(() => {
                deckPile.classList.remove('deck-drawing');
            }, 400);
        }

        function endGame(winner) {
            gameOver = true;
            
            // Update win counts
            if (winner === 'player') {
                playerWins++;
                localStorage.setItem('crazyAcesPlayerWins', playerWins);
            } else {
                computerWins++;
                localStorage.setItem('crazyAcesComputerWins', computerWins);
            }
            
            const totalGames = playerWins + computerWins;
            const winRate = totalGames > 0 ? ((playerWins / totalGames) * 100).toFixed(1) : 0;
            
            const gameOverEl = document.getElementById('gameOver');
            const resultText = document.getElementById('resultText');
            const statsText = document.getElementById('statsText');
            
            if (winner === 'player') {
                resultText.textContent = '🎉 You Win!';
                resultText.className = 'result-text win';
                launchConfetti();
            } else {
                resultText.textContent = '😔 Computer Wins';
                resultText.className = 'result-text lose';
            }
            
            statsText.textContent = `Wins: ${playerWins} | Losses: ${computerWins} | Win Rate: ${winRate}%`;
            
            gameOverEl.classList.add('show');
        }

        function resetStats() {
            playerWins = 0;
            computerWins = 0;
            localStorage.removeItem('crazyAcesPlayerWins');
            localStorage.removeItem('crazyAcesComputerWins');
            document.getElementById('statsText').textContent = 'Wins: 0 | Losses: 0 | Win Rate: 0%';
        }

        function launchConfetti() {
            const container = document.getElementById('confettiContainer');
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffa500', '#ff1493'];
            const confettiCount = 150;
            
            for (let i = 0; i < confettiCount; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                    confetti.style.animationDelay = '0s';
                    
                    container.appendChild(confetti);
                    
                    setTimeout(() => {
                        confetti.remove();
                    }, 5000);
                }, i * 30);
            }
        }

        // Preload all card images for instant display during gameplay
        function preloadImages() {
            const imagesToPreload = [
                // Card back
                'https://s3.amazonaws.com/img.playingarts.com/one-small-hd/_backside-evgeny-kiselev.jpg?2',
                // All card images from cardImages object
                ...Object.values(cardImages)
            ];
            
            let loadedCount = 0;
            const totalImages = imagesToPreload.length;
            
            console.log(`Preloading ${totalImages} card images...`);
            
            imagesToPreload.forEach(url => {
                const img = new Image();
                img.onload = () => {
                    loadedCount++;
                    if (loadedCount === totalImages) {
                        console.log(`✓ All ${totalImages} card images preloaded and cached`);
                    }
                };
                img.onerror = () => {
                    loadedCount++;
                    console.warn(`Failed to load: ${url}`);
                };
                img.src = url;
            });
        }

        // Initialize
        preloadImages();
        initGame();
    </script>
</body>
</html>
